---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CookieConsent from '../components/CookieConsent.astro';
import { getLangFromUrl } from '../i18n/utils';

interface Props {
  title: string;
  description: string;
  keywords?: string;
  ogImage?: string;
}

const { title, description, keywords, ogImage } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const canonicalURL = new URL(Astro.url.pathname, Astro.site || 'https://saveeditor.top');
const siteUrl = Astro.site || 'https://saveeditor.top';
const ogImageUrl = ogImage ? new URL(ogImage, siteUrl).toString() : undefined;
const structuredData = [
  {
    '@context': 'https://schema.org',
    '@type': 'Organization',
    name: 'SaveEditor.top',
    url: siteUrl,
    logo: new URL('/favicon.svg', siteUrl).toString(),
  },
  {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: 'SaveEditor.top',
    url: siteUrl,
    publisher: {
      '@type': 'Organization',
      name: 'SaveEditor.top',
      url: siteUrl,
    },
  },
];
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-adsense-account" content="ca-pub-1703945044985159" />

    <!-- Security: Content Security Policy -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net; 
                   frame-src 'self' https://googleads.g.doubleclick.net https://tpc.googlesyndication.com;
                   style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
                   font-src 'self' https://fonts.gstatic.com; 
                   img-src 'self' data: https:; 
                   connect-src 'self' https://www.google-analytics.com https://pagead2.googlesyndication.com;"
    />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K67NRPJ1VR" is:inline></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', 'G-K67NRPJ1VR');
    </script>

    <!-- Google AdSense -->
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1703945044985159"
      crossorigin="anonymous"
      is:inline></script>

    <!-- SEO Meta -->
    <title>{title}</title>
    <meta name="description" content={description} />
    {keywords && <meta name="keywords" content={keywords} />}
    <link rel="canonical" href={canonicalURL} />

    <!-- Hreflang Tags for all 5 languages -->
    {
      (() => {
        const locales = ['en', 'ja', 'ko', 'pt', 'zh-cn'];
        const basePath = Astro.url.pathname.replace(/^\/(ja|ko|pt|zh-cn)/, '');
        return locales.map((locale) => {
          const href =
            locale === 'en'
              ? `https://saveeditor.top${basePath}`
              : `https://saveeditor.top/${locale}${basePath}`;
          return <link rel="alternate" hreflang={locale} href={href} />;
        });
      })()
    }
    <link
      rel="alternate"
      hreflang="x-default"
      href={`https://saveeditor.top${Astro.url.pathname.replace(/^\/(ja|ko|pt|zh-cn)/, '')}`}
    />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalURL} />
    {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImageUrl && <meta name="twitter:image" content={ogImageUrl} />}

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Performance: Preconnect to external origins -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Performance: Font optimization with font-display -->
    <style>
      @font-face {
        font-family: 'System';
        font-display: swap;
      }
    </style>

    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  </head>
  <body
    class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col transition-colors duration-200"
  >
    <!-- Accessibility: Skip to main content -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 focus:z-50 focus:p-4 focus:bg-primary-600 focus:text-white focus:font-bold"
    >
      {
        lang === 'ja'
          ? 'メインコンテンツへスキップ'
          : lang === 'pt'
            ? 'Pular para o conteúdo principal'
            : 'Skip to main content'
      }
    </a>

    <Header />
    <div id="main-content">
      <slot />
    </div>
    <Footer />
    <CookieConsent />
  </body>
</html>
